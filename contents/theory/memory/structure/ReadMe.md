# Python - Memory Structure

## 시작

if 조건 연산자 is를 찾아보다가 넘어왔습니다.  
python은 -5부터 256 까지의 integer들을 모두 배열로 운용 하고 있었습니다.

그렇다면 python은 메모리 구조가 어떻게 되어있고, 어떤 값들이 올라가 있고 우리가 사용하는 값들은 어디에 올라가는 지가 궁금해졌습니다.  
그래서 이 글을 씁니다.

## 본론

### 파이썬의 메모리 할당 방식

파이썬의 모든 것은 객체입니다.

파이썬은 높은 메모리 연산 속도와 파편화를 줄이기 위해서 자체적으로 PyMalloc이라고 불리는 할당자를 사용합니다.

512 바이트 보다 작은 크기의 객체에는 오버헤드를 줄이기 위해서 큰 메모리 블록에서 할당한다. 512 바이트 보다 큰 객체는 C-Malloc로 넘겨버립니다.
작은 객체 할당자는 ``arena, pool, block``라는 3단계의 추상화를 사용합니다. 하나하나 서술해보도록 하겠습니다.

### Block

블록은 특정크기의 메모리 조각입니다. 각 블록은 고정된 크기의 한 파이썬 객체만을 가질 수 있습니다.  <!-- TODO: 수정하기 -->   
그리고 각 블록의 사이즈는 8 ~ 512사이의 8의 배수 크기만큼의 크기만을 가질 수 있습니다.  
그리고 이러한 크기에 따라서 64개의 사이즈 클래스로 구분할 수 있습니다.

 Requests in Bytes | Size of allocated block | size class idx
---|-----|---
   1-8   |  8  | 0 |
  9-16   | 16  | 1 |
  17-24  | 24  | 2 |
   ...   | ... | ... |
 505-512 | 512 |  63 |

### Pool

풀은 같은 크기의 Block들의 모음입니다.  
일반적으로 풀의 크기는 메모리 페이지의 크기와 같습니다.  

제한되어있는 풀은 고정되어있는 블록들이 파편화되지 않도록 도와줍니다.  
만약 객체가 삭제되면 메모리 매니저가 같은 크기의 객체를 할당함으로써 빈공간을 채웁니다

그리고 풀은 같은 size class idx를 가진 것들 끼리 doubly linked list로 서로 그룹화 되어있습니다.

풀은 다음과 같은 3가지 상태를 가집니다

- used  - 부분적으로 할당된 상태
- full  - 모든 블록이 할당되어있는 상태
- empty - 모든 블록이 할당 가능한 상태

### Arena

아레나는 

## 레퍼런스

아래의 문서를 참고하였습니다.

https://rushter.com/blog/python-memory-managment/