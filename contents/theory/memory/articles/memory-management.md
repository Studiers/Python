# Python - Memory Management

## 파이썬의 메모리 할당 방식

파이썬의 모든 것은 객체입니다.

파이썬은 높은 메모리 연산 속도와 파편화를 줄이기 위해서 자체적으로 PyMalloc이라고 불리는 할당자를 사용합니다.

512 바이트 보다 작은 크기의 객체에는 오버헤드를 줄이기 위해서 큰 메모리 블록에서 메모리를 할당합니다. 반면에 512 바이트 보다 큰 객체는 C-Malloc로 넘겨버립니다.
이 할당자는 ``arena, pool, block``라는 3단계의 추상화를 사용합니다.

## Block

블록은 특정 크기의 메모리 조각입니다. 각 블록은 하나의 파이썬 객체만을 가질 수 있습니다.  <!-- TODO: 수정하기 -->   
그리고 각 블록의 사이즈는 8 ~ 512사이의 8의 배수 크기만큼의 크기만을 가질 수 있습니다.  
우리는 이러한 크기를 기준으로 블록들을 64개의 사이즈 클래스로 구분할 수 있습니다.

 Requests in Bytes | Size of allocated block | size class idx
---|-----|---
   1-8   |  8  | 0 |
  9-16   | 16  | 1 |
  17-24  | 24  | 2 |
   ...   | ... | ... |
 505-512 | 512 |  63 |

## Pool

풀은 같은 크기의 Block들의 모음입니다.  
일반적으로 풀의 크기는 메모리 페이지의 크기와 같습니다.  

이렇게 풀을 같은 크기의 블록들만 사용가능하게 제한하는 것은 블록들이 파편화되지 않도록 하는 것에 유리합니다.  
만약 객체가 삭제되면 메모리 매니저가 같은 크기의 객체를 할당함으로써 빈공간을 채워줍니다

같은 size class idx를 가진 풀끼리는 doubly linked list(e. previous, next)로 서로 그룹화 되어있습니다.

그리고 풀은 다음과 같은 3가지 상태를 가집니다

- used  - 부분적으로 할당된 상태
- full  - 모든 블록이 할당되어있는 상태
- empty - 모든 블록이 할당 가능한 상태

## Arena

아레나는 힙에 할당 되어있는 256kb의 메모리 조각이며 64개의 풀들을 제공합니다.  
아레나들도 doubly linked list로 구현되어있어 관리하기 유리하게 되어있습니다.

## 메모리 해제

작은 객체 관리자(할당자)가 OS에 메모리를 리턴하는 일은 드물며 arena가 완전히 비어있을 때 나타납니다.  
예를 들면 짧은 시간동안 많은 양의 임시객체를 사용할 경우에 이러한 일이 발생할 수 있습니다.

## 레퍼런스

아래의 문서를 참고하였습니다.

https://rushter.com/blog/python-memory-managment/

## 소감

그냥 저 글 보고 공부했더니 번역한 기분입니다. (실로 그렇다)